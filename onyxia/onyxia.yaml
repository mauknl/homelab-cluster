apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: onyxia
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://inseefrlab.github.io/onyxia
    chart: onyxia
    targetRevision: 10.32.4
    helm:
      values: |
        # --- 1. Onyxia API Configuration ---
        api:
          nodeSelector:
            kubernetes.io/hostname: rpi5-master
          
          # FORCE TRAFFIC TO STAY INSIDE THE CLUSTER
          hostAliases:
            - ip: "10.43.157.160"
              hostnames:
                - "auth.100.83.110.77.nip.io"
                - "datalab.100.83.110.77.nip.io"

          # Force OIDC Configuration
          extraEnv:
            - name: AUTHENTICATION_MODE
              value: "openidconnect"
            - name: OIDC_ISSUER_URI
              value: "https://auth.100.83.110.77.nip.io/realms/datalab"
            - name: OIDC_CLIENT_ID
              value: "onyxia"
            # Critical: Trust the self-signed cert since we are going internal
            - name: OIDC_SKIP_TLS_VERIFY 
              value: "true"
            
            # S3 Credentials
            - name: ONYXIA_S3_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: onyxia-s3-creds
                  key: accessKeyId
            - name: ONYXIA_S3_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: onyxia-s3-creds
                  key: secretAccessKey

        web:
          nodeSelector:
            kubernetes.io/hostname: rpi5-master

        # --- 2. Onyxia General Settings ---
        ingress:
          enabled: true
          annotations:
            traefik.ingress.kubernetes.io/router.entrypoints: websecure
          hosts:
            - host: datalab.100.83.110.77.nip.io
              paths: ["/"]
          tls:
            - secretName: wildcard-tls
              hosts:
                - datalab.100.83.110.77.nip.io

        s3:
          enabled: true
          URL: "http://minio.minio.svc:9000"
          region: "us-east-1"
          # We leave these empty here because we inject them via extraEnv above!
          accessKeyId: ""
          secretAccessKey: ""

        # --- 3. User Workspace Configuration ---
        regions:
          - id: geekom-cluster
            name: "Geekom Lab (x86)"
            description: "High performance x86 workers"
            type: kubernetes
            namespacePrefix: "user-"
            
            # Force User Pods to Geekom
            nodeSelector:
              kubernetes.io/hostname: geekom-power

            tolerations:
            - key: "workload"
              operator: "Equal"
              value: "heavy"
              effect: "NoSchedule"

            ingress:
              domain: "100.83.110.77.nip.io"
              ingressClassName: traefik
              annotations:
                traefik.ingress.kubernetes.io/router.entrypoints: websecure
            
            # ENABLE TLS (Secure User Pods)
            tls:
               enabled: true
               secretName: wildcard-tls
            
            # THE MAGIC SCRIPT: Copies the certificate to the user's namespace
            initScript: |
              kubectl get secret wildcard-tls -n onyxia -o json \
              | jq 'del(.metadata.namespace,.metadata.creationTimestamp,.metadata.resourceVersion,.metadata.uid)' \
              | kubectl apply -f -
  destination:
    server: https://kubernetes.default.svc
    namespace: onyxia
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
