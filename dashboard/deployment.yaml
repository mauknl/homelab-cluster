apiVersion: apps/v1
kind: Deployment
metadata:
  name: homepage
  namespace: dashboard
spec:
  replicas: 1
  selector:
    matchLabels:
      app: homepage
  template:
    metadata:
      labels:
        app: homepage
    spec:
      serviceAccountName: homepage-user
      nodeSelector:
        kubernetes.io/hostname: rpi5-master
      # 1. The Helper (Init Container)
      initContainers:
      - name: copy-config
        image: ghcr.io/gethomepage/homepage:v1.9.0
        imagePullPolicy: IfNotPresent
        # This copies your settings from the Read-Only source to the Writable destination
        # -L follows links (crucial for ConfigMaps)
        command: ['sh', '-c', 'cp -L /config-source/* /app/config/']
        volumeMounts:
        - name: config-source
          mountPath: /config-source
        - name: app-config
          mountPath: /app/config

      # 2. The Main Application
      containers:
      - name: homepage
        image: ghcr.io/gethomepage/homepage:v1.9.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 3000
        env:
        - name: HOMEPAGE_ALLOWED_HOSTS
          value: "home.192.168.1.179.nip.io"
        - name: LOG_LEVEL
          value: "debug"
        - name: FINNHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: homepage-secrets
              key: finnhub_token
        volumeMounts:
        # We only mount the Writable version here
        - name: app-config
          mountPath: /app/config

      # 3. The Storage Volumes
      volumes:
      # The Read-Only ConfigMap (Your Git files)
      - name: config-source
        configMap:
          name: homepage-config
      # The Writable Scratchpad (Empty start, filled by helper)
      - name: app-config
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: homepage
  namespace: dashboard
spec:
  ports:
  - port: 80
    targetPort: 3000
  selector:
    app: homepage
